

{
  "variables": {
    
    "fcrepo4_version": "4.2.0",
    "packer_fcrepo4_version": "0.1.3",
    
    "packer_project_repo": "http://github.com/ksclarke/packer-fcrepo4",
    
    "aws_access_key": "{{env `AWS_ACCESS_KEY`}}",
    "aws_secret_key": "{{env `AWS_SECRET_KEY`}}",
    "aws_security_group_id": "{{env `AWS_SECURITY_GROUP_ID`}}",
    "aws_region": "{{env `AWS_REGION`}}",
    "aws_instance_type": "{{env `AWS_INSTANCE_TYPE`}}",
    "aws_source_ami": "{{env `AWS_SOURCE_AMI`}}",
    "aws_virtualization_type": "{{env `AWS_VIRTUALIZATION_TYPE`}}",
    "digitalocean_image": "{{env `DIGITALOCEAN_IMAGE`}}",
    "digitalocean_api_token": "{{env `DIGITALOCEAN_API_TOKEN`}}",
    "digitalocean_region": "{{env `DIGITALOCEAN_REGION`}}",
    "digitalocean_size": "{{env `DIGITALOCEAN_SIZE`}}",
    "server_admin_email": "{{env `PACKER_GRAPHITE_EMAIL`}}",
    "packer_build_name": "{{env `PACKER_GRAPHITE_BUILD_NAME`}}",
    "docker_user": "{{env `DOCKER_USER`}}",
    "fcrepo4_server_host_name": "localhost",
    "graphite_server_host_name": "localhost",
    "tomcat_port": "80",
    "tomcat_ssh_port": "443",
    
    "automatic_os_security_updates": "false",
    "automatic_os_reboot": "false",
    "jvm_memory": "500m",
    "jvm_max_perm_size": "128m",
    "keystore_config": "{{env `KEYSTORE_CONFIG`}}",
    
    "fcrepo4_admin_password": "",
    "keystore_password": ""
  },
  "builders": [
    {
      "type": "virtualbox-iso",
      "guest_os_type": "Ubuntu_64",
      "iso_url": "http://releases.ubuntu.com/trusty/ubuntu-14.04.2-server-amd64.iso",
      "iso_checksum": "83aabd8dcf1e8f469f3c72fff2375195",
      "iso_checksum_type": "md5",
      "guest_additions_path": "VBoxGuestAdditions_{{.Version}}.iso",
      "virtualbox_version_file": ".vbox_version",
      "ssh_username": "ubuntu",
      "ssh_password": "packer",
      "ssh_wait_timeout": "480s",
      "headless": true,
      "http_directory" : "configs",
      "boot_wait": "5s",
      "boot_command": [
        "<esc><esc><enter><wait>",
        "/install/vmlinuz noapic preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/ubuntu-14.04-preseed.cfg <wait>",
        "debian-installer=en_US auto locale=en_US kbd-chooser/method=us <wait>",
        "hostname={{ .Name }} <wait>",
        "fb=false debconf/frontend=noninteractive <wait>",
        "keyboard-configuration/modelcode=SKIP keyboard-configuration/layout=us keyboard-configuration/variant=us console-setup/ask_detect=false <wait>",
        "initrd=/install/initrd.gz -- <enter><wait>"
      ],
      "vboxmanage": [
        ["modifyvm", "{{.Name}}", "--memory", "1024"],
        ["modifyvm", "{{.Name}}", "--vram", "128"],
        ["modifyvm", "{{.Name}}", "--cpus", "1"]
      ],
      "shutdown_command": "echo 'packer' | sudo -S shutdown -P now"
    },
    {
      "type": "amazon-ebs",
      "access_key": "{{user `aws_access_key`}}",
      "secret_key": "{{user `aws_secret_key`}}",
      
      "security_group_id": "{{user `aws_security_group_id`}}",
      "region": "{{user `aws_region`}}",
      "associate_public_ip_address": "true",
      
      "source_ami": "{{user `aws_source_ami`}}",
      "instance_type": "{{user `aws_instance_type`}}",
      "ami_virtualization_type": "{{user `aws_virtualization_type`}}",
      
      "ssh_username": "ubuntu",
      "tags": {
        "OS_Version": "Ubuntu",
        "Release": "Fedora Repository {{user `fcrepo4_version`}}"
      },
      
      "ami_name": "{{user `packer_build_name`}} Fedora Repository ({{user `fcrepo4_version`}}) [{{timestamp}}]",
      "ami_description": "A Fedora Repository ({{user `fcrepo4_version`}}) deployment built with Packer.io"
    },
    {
      "type": "docker",
      
      "image": "ubuntu:14.04",
      "commit": "true",
      "pull": "true"
    },
    {
      "type": "digitalocean",
      "api_token": "{{user `digitalocean_api_token`}}",
      
      "image": "{{user `digitalocean_image`}}",
      "region": "{{user `digitalocean_region`}}",
      "size": "{{user `digitalocean_size`}}",
      "droplet_name": "fcrepo4-{{user `fcrepo4_server_host_name`}}",
      "snapshot_name": "{{user `packer_build_name`}} Fedora Repository ({{user `fcrepo4_version`}}) [{{timestamp}}]"
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "only": ["docker"],
      "source": "scripts/run-tomcat-in-docker.sh",
      "destination": "/tmp/run-tomcat-in-docker.sh"
    },
    {
      "type": "file",
      "source": "scripts/fedora-metrics-server.sh",
      "destination": "/tmp/fedora-metrics-server.sh"
    },
   {
      "type": "shell",
      "environment_vars": [
        "KEYSTORE_PASSWORD={{user `keystore_password`}}",
        "KEYSTORE_CONFIG={{user `keystore_config`}}",
        "JVM_MEMORY={{user `jvm_memory`}}",
        "JVM_MAX_PERM_SIZE={{user `jvm_max_perm_size`}}",
        "FEDORA_VERSION={{user `fcrepo4_version`}}",
        "TOMCAT_PORT={{user `tomcat_port`}}",
        "TOMCAT_SSH_PORT={{user `tomcat_ssh_port`}}",
        "SERVER_HOST_NAME={{user `fcrepo4_server_host_name`}}",
        "GRAPHITE_SERVER={{user `graphite_server_host_name`}}",
        "DEBIAN_FRONTEND=noninteractive"
      ],
      "scripts": [
        "scripts/setup-base-system.sh",
        "scripts/install-java.sh",
        "scripts/install-tomcat7.sh",
        "scripts/install-fedora.sh",
        "scripts/configure-authbind.sh"
      ],
      "override": {
        "virtualbox-iso": {
          "execute_command": "echo 'packer' | sudo -S sh '{{.Path}}'"
        }
      }
    },
    {
      "type": "shell",
      "except": ["docker"],
      "environment_vars": [
        "PACKER_PROJECT_REPO={{user `packer_project_repo`}}",
        "SERVER_HOST_NAME={{user `fcrepo4_server_host_name`}}",
        "SERVER_ADMIN_EMAIL={{user `server_admin_email`}}",
        "AUTOMATIC_OS_SECURITY_UPDATES={{user `automatic_os_security_updates`}}",
        "AUTOMATIC_OS_REBOOT={{user `automatic_os_reboot`}}",
        "DEBIAN_FRONTEND=noninteractive"
      ],
      "scripts": [
        "scripts/modify-landscape.sh",
        "scripts/configure-base-system.sh"
      ],
      "override": {
        "virtualbox-iso": {
          "execute_command": "echo 'packer' | sudo -S sh '{{.Path}}'"
        }
      }
    },
    {
      "type": "shell",
      "only": ["docker"],
      "script": "scripts/install-supervisor.sh"
    }
  ],
  "post-processors": [
    {
      "type": "docker-tag",
      "only": ["docker"],
      "repository": "{{user `docker_user`}}/packer-fcrepo4",
      "tag": "{{user `packer_fcrepo4_version`}}"
    },
    {
      "type": "vagrant",
      "only": ["virtualbox-iso"],
      "output": "packer-fcrepo4-{{.Provider}}.box"
    }
  ]
}
